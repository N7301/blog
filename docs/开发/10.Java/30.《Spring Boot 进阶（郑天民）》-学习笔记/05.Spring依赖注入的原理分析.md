---
title: Spring依赖注入的原理分析
date: 2023-04-22 16:11:16
permalink: /pages/0fc51e/
categories:
  - 开发
  - Java
  - 《Spring Boot 进阶（郑天民）》-学习笔记
tags:
  - 
---

## 1. 基本概念

依赖注入（Dependency Injection, DI）：在系统运行时基于某个对象的使用需求，动态提供他所依赖的其他对象，通过依赖注入实现。

## 2. Spring依赖注入原理分析

Spring 中涉及大量类和组件之间的协作与交互。原理上讲，任何一个框架都存在一条核心执行流程，只要抓住这条主流程，我们就能把握框架的整体代码结构，Spring 也不例外。无论采用何种依赖注入机制，前提都是 SpringIoC 容器正常启动。因此，IoC 容器初始化就是我们理解和把握依赖注人实现机制的前提。

下面我们讲解 IoC 容器的初始化过程。结合 Bean 的生命周期，将其梳理为两大步骤：

+ Bean 的注册
+ Bean 的实例化

### 2.1 Bean 的注册

在使用Spring时，我们可以通过获取一个<mark>应用上下文</mark>(ApplicationContext)对象来操作各种 Bean，示例代码如下：

```Java
AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext(AppConfig.class);
```

+ 这里的 ApplicationContext 接口代表的就是一个Spring IoC 容器，而在 Spring 中存在大批 ApplicationContext 接口的实现类。如果**使用基于注解的配置方式，就可以使用上述代码中的 AnnotationConfigApplicationContext 来初始化容器上下文对象**。

看一下 AnnotationConfigApplicationContext 的启动流程，这一流程位于它的构造函数中，如下：

```Java
public AnnotationConfigApplicationContext(Class<?>...annotatedClasses) {
  this();
  //根据注解配置类注册 Bean
  register(annotatedClasses);
  //刷新容器
  refresh();
}

public AnnotationConfigApplicationContext(String...basePackages) {
  this();
  //根据包路径配置扫描 Bean
  scan(basePackages);
  // 刷新容器
  refresh();
}
```

+ 这两个构造函数的作用很明确，一个是根据注解配置类注册 Bean，另一个则是根据包路径配置扫描 Bean。

这里我们**以 register() 方法为例，来讨论 Bean 的注册过程**。该 register() 会依赖 AnnolatedBeanDeinitionReader 工具类来完成 Bean 的注册。这个工具类会遍历所有传入的 annotatedClasses 注解类，然后通过 doRegisterBean() 方法完成注册。

在 doRegisterBean() 方法中，包含了 **Bean 注册过程中的三个核心步骤**，如下图：

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20230422164550.png" alt="$uploadName" style="zoom:75%;" /></center>

+ 首先，我们构建用来描述 Bean 实例信息的 BeanDefinition 对象，这需要将注解配置类信息转成 AnnotatedGenericBeanDefinition 数据结构，而它就是一种 BeanDefinition，包含了 Bean 的构造函数参数、各种属性值以及所添加的注解信息。
  + Bean 的属性值：如 Student 类的 age、name 等，就是属性
+ 然后，我们设置 BeanDefinition 属性，这一步骤完成了对 @Scope、@Primary、@Lazy 等注解的处理。
+ 最后，通过 registerBeanDefinition() 方法完成 Bean 的注册，该方法内部通过 ListableBeanFactory 的实现类 DefaultListableBeanFactory将 Bean 定义信息注册到 Spring IoC 容器中。
  + ListableBeanFactory 是 Spring 中常用的一个 BeanFactory，通过这个接口，我们可以一次获取多个 Bean。

### 2.2 Bean 的实例化

上一小小节中的 Bean 的注册并未完成实例化，只是将 Bean 的定义加载到了容器中。

要根据 Bean 的注册

