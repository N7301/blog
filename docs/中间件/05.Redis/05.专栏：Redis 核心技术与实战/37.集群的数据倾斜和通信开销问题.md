---
title: 集群的数据倾斜和通信开销问题
date: 2023-04-21 17:05:34
permalink: /pages/d3d97d/
categories:
  - 中间件
  - Redis
  - 专栏：Redis 核心技术与实战
tags:
  - 
---

> 参考：
>
> - [37 数据分布优化：如何应对数据倾斜？| 极客时间](https://time.geekbang.org/column/intro/100056701?tab=catalog)
> - [38 通信开销：限制Redis Cluster规模的关键因素| 极客时间](https://time.geekbang.org/column/intro/100056701?tab=catalog)

## 1. 数据分布优化：如何应对数据倾斜？

在 Redis 切片集群中，数据都会按照 CRC 算法的计算值对 Slot 取模，然后再映射到某个实例上。这种方法虽然实现简单，但容易导致一个问题：数据倾斜。

数据倾斜有两类：

- <mark>数据量倾斜</mark>：在某些情况下，实例上的数据分布不均衡，某个实例上的数据特别多。
- <mark>数据访问倾斜</mark>：虽然每个集群实例上的数据量相差不大，但是某个实例上的数据是热点数据，被访问得非常频繁。

如果发生了数据倾斜，那么保存了大量数据，或者是保存了热点数据的实例的处理压力就会增大，速度变慢，甚至还可能会引起这个实例的内存资源耗尽，从而崩溃。这是我们在应用切片集群时要避免的。

这一大节将讨论数据倾斜是如何发生的，以及如何应对。

### 1.1 数据量倾斜的成因和应对方法

当数据量倾斜发生时，数据在切片集群的多个实例上分布不均衡，大量数据集中到了一个或几个实例上，如下图所示：

<center><img src="https://blog-1310567564.cos.ap-beijing.myqcloud.com/img/20230421170847.png" alt="$uploadName" style="zoom:75%;" /></center>

那么，数据量倾斜是怎么产生的呢？这<u>主要有三个原因，分别是某个实例上保存了bigkey、Slot分配不均衡以及Hash Tag</u>。接下来，我们就一个一个来分析，同时我还会给你讲解相应的解决方案。

#### 1.1.1 bigkey 导致倾斜

第一个原因是，某个实例上正好保存了bigkey。bigkey的value值很大（String类型），或者是bigkey保存了大量集合元素（集合类型），会导致这个实例的数据量增加，内存资源消耗也相应增加。

> bigkey 导致的数据量很大造成的倾斜

而且，bigkey的操作一般都会造成实例IO线程阻塞，如果bigkey的访问量比较大，就会影响到这个实例上的其它请求被处理的速度。

其实，bigkey已经是我们课程中反复提到的一个关键点了。为了避免bigkey造成的数据倾斜，一个根本的应对方法是，<font color=blue>我们在业务层生成数据时，要尽量避免把过多的数据保存在同一个键值对中</font>。此外，如果 bigkey 正好是集合类型，那可以把它拆成多个小的集合类型数据，分散保存在不同的实例上。把一个bigkey化整为零、分散保存了，避免了bigkey给单个切片实例带来的访问压力。

需要注意的是，当 bigkey 访问量较大时，也会造成数据访问倾斜。
